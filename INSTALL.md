#Installing Voyage
###Requirements
Before installation, verify you meet the following requirements
#####[Python 2.7.10+](https://www.python.org/downloads/release/python-2710/)
The required version should be installed on Debian Jessie (and up), as well as Ubuntu 16.04 LTS (and up). You can check your current version by `python --version`

If the version available through your package mananger is not 2.7.10 or above, you will need to manually build and install 2.7.10. Luckily, there is a tool for doing that.

	curl -L https://raw.githubusercontent.com/yyuu/pyenv-installer/master/bin/pyenv-installer | bash
	sudo apt-get build-dep python2.7
	pyenv install 2.7.10
	pyenv global 2.7.10
	pip install -U pip

#####[Wget 1.14+](http://www.gnu.org/software/wget/)
You can check your current version by `wget --version`

###Install apt dependencies
```
sudo apt-get update && sudo apt-get install -y python-pip python-dev libxml2-dev libxslt1-dev zlib1g-dev libjpeg-dev python3-pip  libmysqlclient-dev
```
###Install PhantomJS
If PhantomJS is available on your distribution (such as Ubuntu), you may install it using apt-get.
```
sudo apt-get install phantomjs
```
Otherwise, you may install it manually by downloading the [prebuilt version](http://phantomjs.org/download.html) and extracting the contents of the bin directory to `/usr/local/bin`.

###Clone the repo
```
git clone https://github.com/UTMediaCAT/Voyage
```

###Configure virtualenv (optional)
Although using virtualenv is entirely optional, it's recommended to ensure python packages installed with the system do not interfere with Voyage and vice versa. First, ensure virtualenv is installed
```
sudo apt-get install python-virtualenv
```
Then create the virtualenv
```
cd Voyage # (if not already in the directory)
virtualenv env # creates a virtualenv called "env"
```
To enter the virtualenv, run the following command
```
source env/bin/activate
```
You will need to enter the virtualenv before running any of the python commands. You will also need to enter the virtualenv before installing any python packages (such as the next step), otherwise they won't be installed in the right place.

###Install python dependencies
```
cd Voyage # (if not already in the directory)
pip install -r requirements.txt
sudo pip3 install wpull
```

###Run the install script
```
./InstallScript.sh
```

###Install MySql server
[Install and set up a mysql server](https://www.digitalocean.com/community/tutorials/how-to-install-mysql-on-ubuntu-14-04). Afterwards, [create a database](https://www.digitalocean.com/community/tutorials/how-to-create-and-manage-databases-in-mysql-and-mariadb-on-a-cloud-server) named "crawler", and an associated user (optional, but recommended). Ensure the databases is created with the following command:
```
CREATE DATABASE crawler CHARACTER SET UTF8 COLLATE utf8_general_ci;
```
Then put in the database name and credentials in config.yaml in the crawler section.

###Configure django
Create the initial database:
```
cd Voyage/Frontend # (if not already in the directory)
python manage.py syncdb
```
You will be given the option to create the initial administrative user.

Randomize secret key: (**IMPORTANT**)

For production instances, be sure to use a new randomized SECRET_KEY in `Frontend/Frontend/settings.py`. A new SECRET key can be generated by starting python and running the following python script:
```
import random
''.join(random.SystemRandom().choice('abcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*(-_=+)') for _ in range(50))
```

###Configure nginx
While the debug server (the one that is used when starting the server using manage.py) is sufficient for test purposes, it is not recommended to use in production. A proper server such as nginx can handle greater loads and has TLS support.

First install nginx and uwsgi:
```
sudo add-apt-repository ppa:nginx/stable
sudo apt-get update
sudo apt-get install nginx

sudo pip install uwsgi
```

Add the following into a server directive in a nginx conf (for instance, `/etc/nginx/conf.d/default.conf`)
```
    location / {
        include         uwsgi_params;
        uwsgi_pass      localhost:49152;
    }
```
Then get nginx to reload tho configuration.
```
systemctl reload nginx
```

Then create a file named `uwsgi.ini` in any directory (preferably in the same directory as voyage):
```
[uwsgi]
chdir=/var/lib/mediacat/voyage/Frontend # where voyage is installed
wsgi-file=Frontend/wsgi.py
master=true
socket=127.0.0.1:49152
processes=1
harakiri=20
max-requests=5000
vacuum=true
home=/var/lib/mediacat/voyage/env # the location to the virtualenv used (if applicable)
logto=/var/log/uwsgi/mediacat.log # the location for uwsgi logs
env=DJANGO_SETTINGS_MODULE=Frontend.settings
```

To start the uwsgi server, run
```
uwsgi --ini /path/to/uwsgi.ini
```
You will want to configure uwsgi to run automatically with the system. There are many ways of achiving this. For convenience here is a sample systemd unit file:
```
[Unit]
Description=uWSGI
After=syslog.target

[Service]
User=mediacat
Group=mediacat
ExecStart=/usr/local/bin/uwsgi --ini /var/lib/mediacat/uwsgi.ini
# Requires systemd version 211 or newer
RuntimeDirectory=uwsgi
Restart=always
KillSignal=SIGQUIT
Type=notify
StandardError=syslog
NotifyAccess=all

[Install]
WantedBy=multi-user.target
```